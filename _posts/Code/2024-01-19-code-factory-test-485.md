---
title: "485通道对托测试时序问题"
description: 
date: 2024-01-19 10:00:00 +0800
categories: [Code, Common]
tags: [Code, Common]
pin: false

media_subpath: ""
#
# image:
#   path: 'assets/**/**.jpg'
#   alt: Here is the text under the image
---

## 485产测原理
1. 高优先级线程接收485测试指令，通过置位相应的全局标志位传递所测试的485通道，并调用测试：根据对托原则设置相应的地址，若通道1&2对托，欲测试通道1，则置位通道1的全局标志位，对通道1调用modbud_read函数，向通道2发送查询指令并开始等待回复，尝试获取从通道2发送至通道1的信息，此时高优先级线程自动放弃CPU使用权直到接收到信息或到达超时时间；  
2. 低优先级线程（更低优先级）检查相应的全局标志位，若置位，等待10ms，对通道2调用modbud_read函数，尝试获取从通道1发送至通道2的查询指令，当接收到指令时，将预先设定的回复数据通过modbus_reply回复回去；  
3. 高优先级接收到低优先级线程回复的数据后，与预先设定的回复数据进行比对，若一致，则返回测试成功结果

## 存在的问题
1. 作为slave时需要另外设置超时时间，否则数据接收接口默认为无限等待，若错过或未接收到发送过来的数据，就会导致低优先级线程一直被阻塞，无限等待，此问题在485接口未进行对托时，可稳定复现出

2. 485通信有部分会测试失败，且出现了对托的一对只有一个测试不通过的情况：
 
在产线进行分析，发现在使用提测程序进行测试时，容易复现该问题，而对提测程序打开日志尝试抓日志进行分析时，485测试不通过现象消失；
  
通过在MCU1测查看日志，发现MCU2返回了测试失败信号，并非没有执行测试；
  
解决方案：在work线程接收通道1的指令前延时10ms后，测试不通过问题基本消失。
  
原因：新板变更了部分硬件物料，如电容容量、485电路阻容等，且发版的提测软件基本关闭了所有的调试日志输出，一定程度上加快了整个系统的运行速度，485芯片具有发送使能和接收使能引脚，低电平使能R，意思是在发送后，使能信号从高电平完全变为低电平需要1.5ms，即1.5ms后才能开始接收，因此在未延时前，回复数据在接收引脚变为低电平使能成功前到达，导致数据丢失（旧板子的电容放电时间是6us左右，因此不会出现该问题）。在延时后，查询指令先进入串口内的硬件缓存中，在10ms后被读取并回复，此问题解决。（更改了阻容之后请求和收到回复之间至少要间隔1.5ms以上，未更改阻容之前只要6us以上就足够）
