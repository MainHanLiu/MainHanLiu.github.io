---
title: "Protocol: IIC"
description: 
date: 2023-09-08 10:00:00 +0800
categories: [Protocol, IIC]
tags: [Protocol, IIC]
pin: false

media_subpath: ""
#
# image:
#   path: 'assets/**/**.jpg'
#   alt: Here is the text upder the image
---

## 半/全双工分类
- 半双工总线：IIC总线，三线制SPI，CAN总线，RS-485  
- 全双工总线：4线制SPI，RS-232  ，RS-422

## IIC  
### 简介
IIC全称Inter-Integrated Circuit (集成电路总线)，由PHILIPS公司在80年代开发，I2C属于两线式串行总线，属于一主多从的半双工总线结构，总线上的每个设备都有一个特定的设备地址，以区分同一I2C总线上的其他设备。物理I2C接口有两根双向线，串行时钟线（SCL）和串行数据线（SDA），可用于发送和接收数据，但是通信都是由主设备发起，从设备被动响应，实现数据的传输。

I2C有三种数据传输速率可供选择，分别是标准模式（可达100kbit/s）、快速模式（可达400kbit/s）和高速模式（可达3.4Mbit/s，一般来说比较少）。普通的芯片只有低速100K与高速400K两种规格。

由于连接到I2C总线的器件有不同种类的工艺(CMOS、NMOS、双极性)，逻辑0（低）和1（高）的电平不是固定的，它由VDD的相关电平决定。

时钟线（SCL）和数据线（SDA）接上拉电阻(大小由速度和容性负载决定一般在3.3K-10K之间)，默认高电平（由外部电源提供，开漏本身只能输出低电平和高阻态），表示总线是空闲状态。
上拉到高电平就是指使这个引脚上的电压超过一个值，比如3.3V LVCOMS 的输出高电平的最低值2.4V，只要你想办法把电压弄到高于2.4V就算是“拉到高电平”。

当总线空闲时，SCL和SDA这两条线路都是高电平，连接到总线的器件输出级必须是漏极开路或集电极开路才能执行线与的功能。

I2C协议相对于其他串行通信协议最大的优势就是通过「开漏输出」和「上拉电阻」两个物理特性大大简化了协议整体的设计和实现。

![输入图片说明](/imgs/protocol-iic/2023-09-08/MCXQxRWhDgt0aEqs.png)

上拉电阻阻值对I2C协议的影响
>需要补充说明的一点是，两个上拉电阻的大小并不是随便用的，涉及到通信速率与功耗的取舍。协议层对电平的变化时间有着严格的要求与限制，而电平的变化受总线电气特性的影响。

对总线而言，上拉电阻越大，信号的上升时间就越长，通信速率就越低，反之亦然。但电阻也并不是越小越好，阻值过小的话，总线低电平时电阻上的大电流会增加电路的功耗。此外，电容也会影响信号的上升时间，于是就有了I2C总线总电容400pf的限制，这直接关系到总线上可挂载设备的数目。

IIC使用开漏输出的原因
1. IIC协议支持多个主设备与多个从设备在一条总线上,如果不用开漏输出,而用推挽输出,会出现主设备之间短路的情况。至于为什么需要上拉电阻,那是因为IIC通信需要输出高电平的能力。
2. 为了实现多个主设备抢占总线时的仲裁。

因此,模拟IIC一定要将GPIO端口设置为开漏输出并加上上拉电阻。(硬件IIC会自动配置为开漏输出)

### 完整的数据传输
以「主发送器」工作方式为例，在开始数据传输前，主机会发送一个起始信号，紧接着发送目标从机地址，从机被寻址后产生响应信号，接着主机开始发送数据，从机接收数据并产生响应信号，在数据传输完毕时主机发送结束信号，通讯结束。这就是I2C通讯的大致流程。  
![输入图片说明](/imgs/protocol-iic/2023-09-08/FazgkjrwJvU6lVmp.png)

>起始(START)信号:I2C通信的起始信号由主设备发起，时钟线SCL保持高电平，数据线SDA由高电平跳变到低电平。
>  
>停止(STOP)信号:I2C通信的停止信号由主设备终止，时钟线SCL保持高电平，数据线SDA由低电平跳变到高电平。 
> 
>应答信号(ACK：有效应答，NACK：无效应答)  
>>接收端收到有效数据后向对方响应的信号，发送端每发送一个字节(8位)数据，在第9个时钟周期释放数据线去接收对方的应答。  
当SDA是低电平为有效应答(ACK)，表示对方接收成功(因为上拉默认为高)；主机和从机都需要响应ACK。  
当SDA是高电平为无效应答(NACK)，表示对方没有接收成功。一般在接收数据的最后一个字节，发送NACK，表示接收完成。  
>
>发送到SDA线上的每个字节必须为8位。每次传输可以发送的字节数量不受限制。每个字节后必须跟一个响应位。首先传输的是数据的最高位(MSB)。如果从机要完成一些其他功能后（例如一个内部中断服务程序）才能接收或发送下一个完整的数据字节，可以使时钟线SCL保持低电平迫使主机进入等待状态，当从机准备好接收下一个数据字节并释放时钟线SCL后（时钟同步），数据传输继续。
>
>当从机不能响应从机地址时（例如它正在执行一些实时函数不能接收或发送），从机必须使数据线保持高电平，主机然后产生一个停止条件终止传输或者产生重复起始条件开始新的传输。  

![起始、停止](/imgs/protocol-iic/2023-09-08/i6ckk79HThOLKjxz.png)

>重复起始信号  
在通信过程中若要改变目的从机或者数据传输方向，可以不发送结束信号直接再发送一次起始信号，紧接着发送新的从机地址或传输方向，这个起始信号称为「重复起始信号（Sr）」，本质上和普通起始信号相同，但避免了结束、起始信号反复多次发送。在多主机的总线中使用重复起始信号可保持主机对总线的控制权，避免结束信号临时释放总线造成控制权丢失。

>从机地址、数据传输方向  
在发送完起始信号后，主机紧接着需要发送一个字节（10地址模式下两个字节）的地址信息，包括7位的从机地址以及一位传输方向控制位，「0」表示发送数据（写），「1」表示请求数据（读）。

>数据有效性  
I2C协议规定了SDA线上的数据只在SCL为高电平时有效，在SCL为低电平时可进行数据的切换，即设备只在SCL线为高电平时才会对SDA上的信号进行采样。这里指的数据包括传输数据、从机地址等二进制数据。根据数据传输的特点，可以通过改变SCL时钟信号的占空比灵活调整数据的采集和切换时间。时钟信号SCL为高电平期间，数据线SDA上的数据必须保持稳定，只有在时钟线SCL上的信号为低电平期间，数据线SDA上的高电平或低电平状态才允许变化，因为当SCL是高电平时，数据线SDA的变化被规定为控制命令（START或STOP，也就是前面的起始信号和停止信号）。  
![输入图片说明](/imgs/protocol-iic/2023-09-08/VvDi26ANVVhbcMHj.png)

>响应信号  
在从机被寻址或者主机/从机接收一字节数据后，都要在地址或数据后产生一个响应信号。响应信号包括「应答(ACK)」和「非应答(NACK)」两种信号。所谓的作出应答就是在SCL线电平升高前设备将SDA线拉低，而产生非应答信号，设备只要在这时什么也不干，释放总线即可。所以在使用STM32 I2C接口时不一定要等到数据接收完成后才使能非应答信号，实际上在前一次应答信号发出后就可以干这事了。  
![输入图片说明](/imgs/protocol-iic/2023-09-08/fOZfFlZ4SCxBhzpj.png)

### I2C 基本读写过程
在用单片机作为主机进行I2C通信控制外设时，根据数据传输方向可将I2C数据传输模式分为三类：主机发送模式，主机接收模式，复合模式。

>主机发送模式  
在主机发送模式下，同一次通信过程中数据传输只由主机到从机，报文格式如下图：  
![输入图片说明](/imgs/protocol-iic/2023-09-08/OarxQ5FxieELSTko.png)  
在产生起始信号后，主机发送包含7位地址以及「写」控制位的一个字节数据，随后开始逐字节传输数据，并接收从机对各字节的响应信号。当从机响应非应答信号时，主机产生结束信号终止通信。当然，因为主机是「大佬」，也可以随时产生结束信号终止通信。

>主机接收模式  
在主机接收模式下，同一次通信过程中数据传输只由从机到主机，报文格式如下图：  
![主机接收模式](/imgs/protocol-iic/2023-09-08/UB84G8gpm5rgpjxQ.png)  
在产生起始信号后，主机发送包含7位地址以及「读」控制位的一个字节数据，随后开始逐字节接收从机数据，并产生对各字节的响应信号。数据接收完毕时，主机产生非应答响应信号时，随后产生结束信号终止通信。要注意主机在发送结束信号前先要产生非应答响应信号。

>复合模式  
前面两种模式中的数据传输方向都是固定的——只由主机到从机或只由从机到主机，而在复合模式下，主机可以通过重新发送起始信号改变数据传输方向，即同一次通信过程中存在两个数据传输方向，报文格式如下图：  
![复合模式](/imgs/protocol-iic/2023-09-08/VYgjLCDuMv7o48JR.png)  
复合模式结合了前两种模式的特点，主机通过发送重复起始信号改变数据传输方向，实现读/写切换。同样的，接收数据的主机要想改变方向或者终止通信，在发送重复起始信号和结束信号前都要先产生非应答响应信号。  
复合模式可以实现主机数据的「先发送后接收」，最典型的应用是通过I2C总线控制EEPROM读数据——主机（MCU）先发送要读取数据在EEPROM内的地址，随后切换模式接收EEPROM返回的数据。

IIC的一个优点是它支持多主控(multimastering)，其中任何一个能够进行发送和接收的设备都可以成为主总线。一个主控能够控制信号的传输和时钟频率。当然，在任何时间点上只能有一个主控。
通常我们为了方便把IIC设备分为主设备和从设备，基本上谁控制时钟线（即控制SCL的电平高低变换）谁就是主设备。

SCL线可以配置推挽输出,开漏输出(有上拉电压存在)都可,因为不用兼具输入扫描功能;  
SDA线必须配置开漏输出,因为要兼具输入扫描功能。  

### 时钟同步和仲裁  
如果两个或多个主机尝试发送信息到总线，在其他主机都产生0的情况下，首先产生一个1的主机将丢失仲裁，仲裁时的时钟信号是用线与连接到SCL线的主机产生的时钟的同步结合。 
#### 线与逻辑  
开漏输出支持“线与”，开漏输出常用于单线双向传输(I2C, One-Wire)。正是由于开漏输出的「要么拉低要么放手」的特性，使得总线只受输出端低电平的影响（同样，设备也只能通过输出低电平来使用总线）。I2C 总线电路的真正主角，是连接总线到 VCC 的两个上拉电阻。开漏输出端只能输出低电平或高阻态，是不能把总线拉高的，自然而然就需要通过其他方式为总线提供高电平，上拉电阻就担负了这个重任——当输出端输出高阻态且没有其他设备拉低总线（占用总线）时，总线被外部的上拉电阻拉高，呈现出高电平状态。总线上任何一个设备都可以使用开漏输出将总线变为低电平，并且所有其他设备都会检测到低电平。 
#### 时钟同步  
所有主机在SCL线上产生它们自己的时钟来传输I2C总线上的报文，数据只在时钟的高电平周期有效因此，需要一个确定的时钟进行逐位仲裁。  
时钟同步通过线与连接I2C接口到SCL线来执行。这就是说，SCL线的高到低切换会使器件开始数它们的低电平周期，而且一旦器件的时钟变低电平，它会使SCL线保持这种状态直到到达时钟的高电平，但是，如果另一个时钟仍处于低电平周期（如CLK2），这个时钟(CLK1)的低到高切换不会改变SCL线的状态，因此SCL线被有最长低电平周期的器件保持低电平，此时低电平周期短的器件(CLK1)会进入高电平的等待状态  
![输入图片说明](/imgs/protocol-iic/2023-09-08/dljOwOIwM89Rov4t.png)  
当所有有关的器件数完了它们的低电平周期后，时钟线被释放并变成高电平。之后，器件时钟和SCL线的状态没有差别。而且所有器件会开始数它们的高电平周期。首先完成高电平周期的器件会再次将SCL线拉低。  
**这样，产生的同步SCL时钟的低电平周期由低电平时钟周期最长的器件决定，而高电平周期由高电平时钟周期最短的器件决定**

#### 仲裁
主机只能在总线空闲的时侯启动传输。两个或多个主机可能在起始条件的最小持续时间内产生一个起始条件， 结果在总线上产生一个规定的起始条件。  
当 SCL 线是高电平时，仲裁在SDA线发生。这样，在其他主机发送低电平时，发送高电平的主机将断开它的数据输出级，因为总线上的电平与它自己的电平不相同。  
![输入图片说明](/imgs/protocol-iic/2023-09-08/5qMQLqwG527F3WWt.png)  
假设主控器1要发送的数据DATA1为“101……”；主控器2要发送的数据DATA2为“100……”。  
DATA1和DATA2均在SCL为高期间产生了起始信号，总线根据其紧接着传送的从机地址进行仲裁。总线被启动后两个主控器在每发送一个数据位时都要对自己的输出电平进行检测，只要检测的电平与自己发出的电平一致，他们就会继续占用总线。在这种情况下总线还是得不到仲裁。当主控器1发送第3位数据“1”时（主控器2发送“0”），由于“线与”的结果SDA上的电平为“0”，这样当主控器1检测自己的输出电平时，就会测到一个与自身不相符的“0”电平。这时主控器1只好放弃对总线的控制权；因此主控器2就获得总线的控制权。 

## STM32中使用IIC
了解I2C总线协议的基本规定后，可以发现所谓的XXX协议，不过就是根据一个标准进行总线上高低电平的变化而已。这种电平变化无论是用单片机C语言软件实现、还是众多IC固化的硬件接口实现，甚至把两条总线通过拨码开关接到VCC/GND进行纯手动操作（你可以想象在快速模式I2C下，极客的手指以400Hz的频率在「抽搐」，只为了实现真正的「人机交互」），理论上只要能产生符合协议规范的「特征电平」信号，两个I2C设备就能通信，于是就有了我们常说的「一个协议的两种实现方式」——「软件模拟」和「硬件实现」。

- 软件模拟
软件模拟是通过编程语言控制单片机I/O口的电平来产生通信协议的各种信号。因为每一个电平变化都是码农一下下敲出来的（类似于「LED=0;」这样的代码），给人一种「一切尽在掌握之中」的感觉，软件模拟方式会让人有一种久违的「安全感」，具体表现为可控性高、灵活性强的优点，但同时也要付出代价：很显然，MCU监控或查询总线的次数越多，用于执行自己功能的时间越少。

- 硬件实现
随着时代的发展，单片机上的外设越来越多、越来越强大，与串口、定时器、I/O口一样，I2C也可以固化为MCU外设，协议各种信号的发送/接收都可以由硬件自动完成，并通过众多寄存器给MCU开发者提供使用接口，码农们只需要「面向寄存器编程」。

使用STM32的I2C接口外设时，要发送就往外设的数据寄存器扔数据，要接收就从外设的数据寄存器读数据，各种控制信号的产生也可以通过写相应的外设控制寄存器位完成。或许你觉得就这样「放手硬件」有点不放心，万一被硬件坑了怎么办？别怕，STM32还有一堆的状态寄存器供你判断外设工作状态。另外，硬件还为通信过程中的各种情况实现了中断，这些都是用软件模拟法所没有的福利。

## Reference
- [# I2C 总线协议初探:STM32 I2C 接口外设学习笔记](https://www.shaoguoji.cn/2017/04/25/study-i2c-bus/)  
- [# I2C总线规范](https://files.chinaaet.com/files/group/2011/07/24/9007438299002.pdf)  
