---
title: "RS485总线与Modbus"
description: 
date: 2023-09-11 11:00:00 +0800
categories: [Protocol, Modbus]
tags: [Protocol, RS485, Modbus]
pin: false

media_subpath: ""
#
# image:
#   path: 'assets/**/**.jpg'
#   alt: Here is the text upder the image
---

## RS485总线/接口
### 简介
　　现在，为什么公司不直接使用 USB 或以太网在设备之间传输数据呢？与串行通信相比，USB 和以太网更加复杂和昂贵。串行通信还具有确定性行为，以避免数据包冲突，使其对于具有许多设备的联动系统更加可靠。最终，与常见的 USB 和以太网相比，串行通信更适合这种用途。  
　　RS-232是串行数据接口标准，最初都是由电子工业协会（EIA）制订并发布的，RS-232在1962年发布，命名为EIA-232-E，作为工业标准，以保证不同厂家产品之间的兼容。  
　　RS-422由RS-232发展而来，它是为弥补RS-232之不足而提出的。为改进RS-232通信距离短(最大传输距离15m)、速率低的缺点(最大位速率为20Kb/s)，RS-422定义了一种平衡通信接口，将传输速率提高到10Mb/s，传输距离延长到1200米（速率低于100kb/s时），并允许在一条平衡总线上连接最多10个接收器。RS-422是一种单机发送、多机接收的单向、平衡传输规范，被命名为TIA/EIA-422-A标准。  
　　为扩展应用范围，EIA又于1983年在RS-422基础上制定了RS-485标准，增加了多点、双向通信能力，即允许多个发送器连接到同一条总线上，同时增加了发送器的驱动能力和冲突保护特性，扩展了总线共模范围，后命名为TIA/EIA-485-A标准。由于EIA提出的建议标准都是以“RS”作为前缀，所以在通讯工业领域，仍然习惯将上述标准以RS作前缀称谓。  
　　RS-232、RS-422与RS-485标准只对接口的电气特性（电压，阻抗）做出规定，而不涉及接插件、电缆或协议，在此基础上用户可以建立自己的高层通信协议。  

　　为扩展应用范围，美国电子工业协会(EIA)于1983年在RS-422基础上制定了RS-485（目前称为EIA/TIA-485）标准，增加了多点、双向通信能力，即允许多个发送器连接到同一条总线上，同时增加了发送器的驱动能力和冲突保护特性，扩展了总线共模范围，后命名为TIA/EIA-485-A标准。RS-485 的诞生是为了扩展 RS-232 接口的物理功能。RS-485是物理层的通信接口标准，是一种信号传输方法， OSI（开放系统互连）模型的第一级。  
　　RS-485总线弥补了RS-232通信距离短，速率低的缺点，RS-485的速率可高达10Mbit/s，理论通讯距离可达1200米；RS-485和RS-232的单端传输不一样，是差分传输，使用一对双绞线，其中一根线定义为A，另一个定义为B。  
　　RS485通信最大的通信距离约为1219m，最大传输速率为10Mbps，传输速率与传输距离成反比，在100KbpS的传输速率下，才可以达到最大的通信距离，如果需传输更长的距离，需要加485中继器。RS-485总线一般最大支持32个节点，如果使用特制的485芯片，可以达到128个或者256个节点，最大的可以支持到400个节点。  
　　RS-485的物理层负责在设备和物理传输介质之间传输原始数据。它处理电信号到数字数据的转换，同时定义电压、时序、数据速率等。  
　　RS-485采用半双工工作方式，支持多点数据通信。RS-485总线网络拓扑一般采用终端匹配的总线型结构。即采用一条总线将各个节点串接起来，不支持环形或星型网络。  
　　长距离布线会有信号衰减，而且引入噪声和干扰的可能性更大，在线缆A和B上的表现就是电压幅度的变化，但是，采用差分线的好处就是，差值相减就会忽略掉干扰依旧能输出正常的信号，把这种差分接收器忽略两条信号线上相同电压的能力称为共模抑制。  
　　![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/OAIk16w4kUqEP2Ll.png)  
　　标准规定了，逻辑1：＋2V ～ ＋6V；逻辑0：-6V ～ -2V。  
　　RS-485不需要使用特定的总线电压，只看最小差分电压，在较长的电缆长度上，接收器接收到的电压可能会降低到+/-200 mV，这对于RS-485仍然是完全可以接受的，这也是RS-485的优点之一。很多收发器的标准达到甚至超过TIA/EIA-485A规范，在实际使用中，以器件的SPEC参数为主。RS-485收发器的发送电路至少提供1.5V差分电压输出能力，经由总线线路阻抗衰减，32个接收电路输入阻抗，以及120Ω端接电阻，差分信号的幅度必然逐渐衰减，那么至最末端还需要至少提供200mV的差分电压给末端接收电路，否则接收端就无法正确识别0/1了。  
　　符合 RS-485 标准的驱动器在 54 Ω 负载上提供最小 1.5 V 的差分输出，而符合标准的接收器则检测低至 200 mV 的差分输入。即使在电缆和连接器信号严重衰减的情况下，这两个值也为可靠的数据传输提供了足够的余量。这种稳健性是 RS-485 非常适合在嘈杂环境中进行长距离联网的主要原因。  
　　对于驱动器（发送器），逻辑1（正）是A>B, AB之间电压为+2 ~ +6V，而逻辑0（负）是A<B，AB之间的电压为-2 ~ -6V。而对于接收器，逻辑1（正）是B>A，BA之间的电压不小于200mV，逻辑0是A>B，BA之间的电压小于-200mV，即正负逻辑，电压绝对值都大于200mV。
　　![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/pT1MtCW4pFxBcFpY.png)  
　　![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/wYlM34A4q9rRH9Ax.png)  
　　
> 120Ω端接电阻  
> 首先为什么要端接？这是由于RS-485采用双绞线传输，标准规定的双绞线的差分特征阻抗在100Ω至150Ω之间。RS-485标准制定者选择120Ω作为标称特征阻抗。  
> 假定信号自左边站点发出，如果没有端接，信号在线路上传输其阻抗是连续的，但是到达右侧的时候则，等效阻抗变成了接收电路的输入阻抗，比如是12kΩ，阻抗不连续了，阻抗突变！信号的一部分能量就会按照原路径返回，如返回回去的信号由于容抗及感抗，就会产生相差。反射回去的信号与原信号叠加在一起。这样就会造成通信发生错误，严重的时候，通信就无法正确进行。要想更深入的了解背后的原理，可以去学习一下传输线理论。因此为了消除信号反射，使电缆的末端的阻抗和电缆的特性阻抗大小一样，在通讯电缆的另一端跨接一个120欧的终端电阻。在实际中，由于线缆的特性阻抗不可能与终端电阻完全相等，因此或多或少的信号反射还是会存在的;  

　　现在很多的RS-485转换器都是兼容RS-422的，所以看到很多转换器上面的信号都是T/R+、T/R-，即对应RS-485的A+和B-。  
　　![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/HLqdKXeK2HY85Fts.png)  
　　RS485有两线制和四线制两种接线，四线制只能实现点对点的通信方式，现很少采用，多采用的是两线制接线方式，这种接线方式为总线拓扑结构，在同一总线上最多可以挂接32个节点。  
　　RS-485总线同I2C，也是主从模式，支持点对点单从机模式，也支持多从机模式，不支持多主机模式。RS-485是差分传输，如果用单片机控制RS-485接口的设备，需要用到收发器，这一点和CAN总线是类似的。如图。    
　　![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/WfLPTnBV3GcSWHZX.png)    
　　![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/52iIgpcmCcuqIKd5.png)    
　　RS-485的数据链路：　  　  
　　![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/63mOeTn54oorTMCC.png)    
　　![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/OvLs8rTiGdNkKVBM.png)    
>因为单片机通信一般是TTL电平，而我们的外接设备如果是485设备，通信的电平就是485电平，这两者的电平是不一样的，所以两者不能直接相接一起。中间需要一个电平转换的芯片来协商一下，所以就有了我们的485芯片。因为485通信是半双工的，就是发送数据的时候不能同时接收数据，所以我们又把485芯片叫做半双工收发器。而SP3485芯片就是一款非常经典的低功耗半双工收发器，满足RS-485串行协议要求。  
>这款芯片的引脚定义如下：  
RO 一 接收器输出  
RE 一 接收器输出使能（低电平有效）  
DE — 驱动器输出使能（高电平有效）  
DI 一 驱动器输入  
GND 一 连接地  
A — 驱动器输出/接收器输入（同相）  
B — 驱动器输出/接收器输入（反相）  
VCC —芯片供电  
485通讯模块大家普遍用的只有两种芯片，SP3485和MAX485，而且原理图画的都差不多。

　　主机发送给从机或者从机发送给主机，都会占用到A和B线，所以RS-485多用在半双工模式。    
　　主机的GPIO会控制RS-485收发器的DE管脚，设置发送模式，从UART TX线向RS-485收发器的数据线（D）发送一个字节，收发器将在A和B线上将单端UART位流转换为差分位流，数据离开收发器后，主机立即将收发器的模式切换为接收模式。  
　　从机和主机是类似的，从机控制RS-485收发器的/RE管脚，设置为接收模式，接收主机发送的比特流，将其转换为单端信号，通过从机的UART RX线接收，当从机准备好响应时，它按主机原来的方式进行发送，而主机变为接收。  
　　485收发器在规定的共模电压-7V至+12V之间时，才能正常工作。如果超出此范围会影响通讯，严重的会损坏通讯接口。共模干扰会增大上述共模电压。消除共模干扰的有效手段之一是将485通讯线的屏蔽层用作地线，将机具、电脑等网络中的设备地连接在一起，并由一点可靠地接入大地。  
> RS-232和RS-485转换  
> RS-232和RS-485之间可以转换，一个方法是RS-232转换成TTL，再由TTL转换为RS-485，当然也有芯片支持将RS-232直接转换成RS-485，网上有很多模块。  
> ![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/RY4cZKJ0kbaQWeQf.png)      

> RS-485和CAN的区别  
> 虽说RS-485没有标准的数据协议格式，但和CAN总线在很多地方是有相似的，比如A&B和CANH&CANL都是差分信号，通信都需要收发器，都需要120欧姆的匹配电阻等等。  
> ![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/7E59ur3HVfc4j3rx.png)  

工业 IP68 Modbus RS485 1 对 4 分配器/集线器  
![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/apmbWwpaTjU859U4.png)  
该分线器设计用于与 传感器集线器配合使用，能够将 1 个 MODBUS RS485 端口“拆分”为 4 个。RS485 分线器具有 1 个连接到传感器集线器的公接口和 4 个连接到传感器的母接口。作为户外恶劣环境下经常使用的连接器，其设计达到IP68级防水防尘。这意味着它可以防止与所有灰尘颗粒以及高压水射流接触！它还具有抗紫外线和防雨功能，适合长期户外使用。  

**绿联 USB转 RS-485/422转换器**  
![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/TrEZZretLar5c2FH.png){: w="80%" }   
![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/QP8IdmHrSK4kNCMO.png){: w="90%" }   

![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/xUHL4jD1WlqyO2DE.png){: w="80%" }   
![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/GUZtyFpUfRZneqRh.png){: w="80%" }  

### RS485自动收发电路
RS485抗噪音抗干扰能力强、传输距离远、支持多点通信，是工控行业首选串行接口。485规定的电气特性为2线，半双工多点通信。采用两线差分信号传输数据，具有抗共模干扰的能力。

485通讯模块大家普遍用的只有两种芯片，SP3485和MAX485，而且原理图画的都差不多。

- **传统RS485电路**  

![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-26/vQJyV9tCxLSnIlkJ.png)    
原理：因为单片机通信一般是TTL电平，而我们的外接设备如果是485设备，通信的电平就是485电平，这两者的电平是不一样的，所以两者不能直接相接一起。中间需要一个电平转换的芯片来协商一下，所以就有了我们的485芯片。因为485通信是半双工的，就是发送数据的时候不能同时接收数据，所以我们又把485芯片叫做半双工收发器。而SP3485芯片就是一款非常经典的低功耗半双工收发器，满足RS-485串行协议要求。  

一般将DE和RE接在一起，单片机MCU向外发送数据时，将USART_EN置1，单片机MCU接收外界数据时，将USART_EN置0。

当我们在写程序时候，就相对会比较麻烦，因为我们要在接收和发送时将USART_EN引脚置位不同的电平。那么有没有一种可以自动收发功能的电路呢？答案是有的，只要我们在这个电路的基础上加一个三极管就可以解决了。

-  **自动切换收发的RS485电路** 

![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-26/JS8EykRKInp1vpNR.png)  
大家看我们在前面电路的基础上加了一个经典的三极管开关电路。电阻R6、电阻R7和NPN三极管Q1组成一个典型的三极管开关电路。R7是限流电阻，最好选择4.7K，也可以选择10K。R6是上拉电阻，可以选择4.7K或者10K。  

当TX高电平，三极管导通，RE和DE引脚接地，进入接收模式。  
当TX低电平，三极管截止，RE和DE引脚接高电平，进入发送模式。  

>发送数据过程  
发送数据，用的是TXD引脚，TXD会依次的用高低电平体现1和0。  
当TXD发送0时，三极管截止，DE接高电平，进入发送模式，485发送器会把DI上的电平反映到AB引脚上输出，因为DI已经接地，AB引脚会传输0。所以，当TXD发送0时，AB引脚发送0。  
当TXD发送1时，三极管导通，RE接低电平，驱动器D的输出为高阻态（类似于下图中从红线位置断开），A和B此时并不处于高阻态，只是等效于断开了与DI的连接，这个时候虽然/RE=0，接收器R开始输出数据到RO， 但我们关注的并非接收器。因为R3把A拉高，R2把B拉低，此时A = 1, B = 0（代表高电平），485接收器的AB引脚表现的是1。所以，当TXD发送1时，AB引脚等效发送1。  
![输入图片说明](/imgs/protocol-rs485-modbus/2023-10-18/CaCyDq4w9RoPCMa7.png)

>接收数据过程  
接收数据，用的是RXD引脚，在RXD引脚上接收数据。在接收数据的过程中，TXD引脚是一直保持高电平的，进入接收模式，485芯片的RO引脚（也就是接RX的引脚）就会接收AB传输过来的数据。  

自动收发RS-485收发器可以节省MCU的IO口，降低编写程序的工作量，但常规的自动收发电路具有通信速度慢，发送高电平信号时RXD会接收到一段低电平信号等问题，因此若需使用自动收发，推荐使用自动收发隔离RS-485收发器。  

###  区别  
![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/hGrv3T3Ead731Vlx.png)  
![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/LmGTiLjFyI4rsrmk.png) 
#### **RS232**  
全双工、点对点通讯（因点对点通讯方式而无法联网，导致出现RS485）  
特点：  
　　(1)接口的信号电平值较高，易损坏接口电路的芯片。RS232接口任何一条信号线的电压均为负逻辑关系。即：逻辑“1”为-3 ~ -15V;逻辑“0”：+3 ~ +15V，噪声容限为2V。即要求接收器能识别高于+3V的信号作为逻辑“0”，低于-3V的信号作为逻辑“1”，TTL电平为5V为逻辑正，0为逻辑负。与TTL电平不兼容故需使用电平转换电路方能与TTL电路连接。  
　　(2)传输速率较低，RS232标准规定的数据传送的波特率有：50、75、100、150、300、600、1200、2400、4800、9600、19200。  
　　(3)接口使用一根信号线和一根信号返回线而构成共地的传输形式，这种共地传输容易产生共模干扰，所以抗噪声干扰性弱。  
　　(4)传输距离有限，最大传输距离标准值为50英尺，实际上也只能用在15米左右。使用RS232协议的设备在发送器和接收器之间的距离被限制为15米，同时仍能实现最大数据传输速率。如果可以容忍较慢的数据速率，则可以延长该长度。  
　　(5)总线只允许连接一个收发器。    

#### **RS422**  
RS422标准全称是“平衡电压数字接口电路的电气特性”，它定义了接口电路的特性。典型的RS-422是四线接口，全双工，差分传输，多点通信的数据传输协议。实际上还有一根信号地线，共5根线。它采用平衡传输采用单向/非可逆，有使能端或没有使能端的传输线。  

由于接收器采用高输入阻抗和发送驱动器比RS232更强的驱动能力，故允许在相同传输线上连接多个接收节点，最多可接10个节点。即一个主设备（Master），其余为从设备（Slave），从设备之间不能通信，所以RS-422支持点对多的双向通信。接收器输入阻抗为4k，故发端最大负载能力是10×4k+100Ω（终接电阻）。RS-422四线接口由于采用单独的发送和接收通道，因此不必控制数据方向，各装置之间任何必须的信号交换均可以按软件方式（XON/XOFF握手）或硬件方式（一对单独的双绞线）实现。  

RS-422的最大传输距离为1219米，最大传输速率为10Mb/s。其平衡双绞线的长度与传输速率成反比，在100kb/s速率以下，才可能达到最大传输距离。只有在很短的距离下才能获得最高速率传输。一般100米长的双绞线上所能获得的最大传输速率仅为1Mb/s。  

RS485和RS422电路原理基本相同，都是以差动方式发送和接受，不需要数字地线。差动工作是同速率条件下传输距离远的根本原因，这正是二者与RS232的根本区别，因为RS232是单端输入输出，双工工作时至少需要数字地线、发送线和接受线三条线（异步传输），还可以加其它控制线完成同步等功能。RS422通过两对双绞线可以全双工工作收发互不影响，而RS485只能半双工工作，发收不能同时进行，但它只需要一对双绞线。  

RS-422 的电气特性与RS-485基本一样。  

RS-485与RS-422的不同还在于其共模输出电压是不同的，RS-485是-7V至+12V之间，而RS-422在-7V至+7V之间，RS-485接收器最小输入阻抗为12kΩ、RS-422是4kΩ；由于RS-485满足所有RS-422的规范，所以RS-485串行接口的驱动器可用于RS-422串行接口的应用中，反之则不能成立。    

RS-485与RS-422一样，其最大传输距离约为1219米，最大传输速率为10Mb/s。平衡双绞线的长度与传输速率成反比，在100kb/s速率以下，才可能使用规定最长的电缆长度。只有在很短的距离下才能获得最高速率传输。一般100米长双绞线最大传输速率仅为1Mb/s。  

###  串口、UART、RS232、RS485、RS422之间的关系  
**串口**是一个泛称，UART，TTL，RS232，RS485都遵循类似的通信时序协议，因此都被通称为串口。  
![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/K9dloZh5UotXGc8k.png)  
UART是通用异步收发传输器(Universal Asynchronous Receiver/Transmitter)，通常称作UART，是一种异步收发传输器（顾名思义，它是一个设备而不是一种协议），是设备间进行异步通信的关键模块。UART负责处理数据总线和串行口之间的串/并、并/串转换，并规定了帧格式;通信双方只要采用相同的帧格式和波特率，就能在未共享时钟信号的情况下，仅用两根信号线(Rx 和Tx)就可以完成通信过程，因此也称为异步串行通信。
>个人理解：将一位字节数据按照规定格式转换为8bit的二进制码数据。  
>起始位、数据位、奇偶校验位、停止位  

若加入一个合适的电平转换器，如SP3232E、SP3485，UART 还能用于RS-232、RS-485 通信，或与计算机的端口连接。UART 应用非常广泛，手机、工业控制、PC 等应用中都要用到UART。  
![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-11/1tiNDwYd5q9vtIAq.png)  
UART的设计采用模块化的设计思想，主要分为 3个模块：数据发送模块、数据接收模块及波特率发生器控制模块。发送模块实现数据由并行输入到串行输出，接收模块实现数据由串行输入到并行输出，波特率发生器模块控制产生UART时钟频率。  
发送逻辑对从发送FIFO读取的数据执行“并→串”转换。控制逻辑输出起始位在先的串行位流，并且根据控制寄存器中已编程的配置，后面紧跟着数据位（注意：最低位 LSB 先输出）、奇偶校验位和停止位。  
在检测到一个有效的起始脉冲后，接收逻辑对接收到的位流执行“串→并”转换。此外还会对溢出错误、奇偶校验错误、帧错误和线中止（line-break）错误进行检测，并将检测到的状态附加到被写入接收FIFO的数据中。  

## **Modbus**
### Definition
Modbus是由Modicon（现为施耐德电气公司的一个品牌）在1979年发明的，是全球第一个真正用于工业现场的总线协议，用于不同厂商之间的设备交换数据。在我国，Modbus已经成为国家标准GB/T19582-2008。通过此协议，控制器相互之间、控制器经由网络（例如以太网）和其它设备之间可以通信。它已经成为一通用工业标准。有了它,不同厂商生产的控制设备可以连成工业网络,进行集中监控。此协议定义了一个控制器能认识使用的消息结构，而不管它们是经过何种网络进行通信的。它描述了一控制器请求访问其它设备的过程,如何回应来自其它设备的请求，以及怎样侦测错误并记录。它制定了消息域格局和内容的公共格式。Modbus 协议简单而强大，是工业控制系统的热门选择。作为一个开放标准，任何人都可以自由地使用和修改，这使得它在整个行业中得到了广泛应用。

[网盘：Modbus协议规范（中文）](https://pan.baidu.com/link/zhihu/7Fh0zcuVhlijMX1Exka3EshzTpW0V2Rwd4NF==)

>GB/T 19582.1-2008	基于Modbus协议的工业自动化网络规范 第1部分：Modbus应用协议  
>https://www.doc88.com/p-3952165987200.html  
>Modbus串行链路基于TIA/EIA标准:232E和485-A｡  
>
>GB/T 19582.2-2008	基于Modbus协议的工业自动化网络规范 第2部分：Modbus协议在串行链路上的实现指南  
>https://www.doc88.com/p-1983438956062.html?r=1  
>Modbus TCP/ IP基于IETF标准: RFC793和RFC791｡
>
>GB/T 19582.3-2008	基于Modbus协议的工业自动化网络规范 第3部分：Modbus协议在TCP/IP上的实现指南
>
>![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/D1yw7CCI7ba0JbK8.png)  
>![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/GJfncWHcF8fsnUFp.png)

Modbus是OSI模型第7层上的应用层报文传输协议, 它在连接至不同类型总线或网络的设备之间提供客户机/服务器通信。数据链路层有两种：基于标准串口协议和TCP协议，物理层可使用3线232、2线485，或光纤、网线、无线等多种传输介质。

Modbus是一种单主站的主/从通信模式。一条Modbus网络上同时只能有一台主站，从站可以有若干个。Modbus支持单主机，多个从机，最多支持247个从机设备。

Modbus协议是一种**请求/应答**方式的交互过程，主机主动发起通讯请求，从机响应主机的请求，从机在没有收到主机的请求时，不会主动发送数据，从机之间不会进行通讯。

工业应用上一般 Modbus 485 波特率为9600 或者 4800，因为速度越快传输距离越短，速度太慢也影响效率。

>Modbus具有以下几个特点:  
1. 标准、开放，用户可以免费、放心地使用Modbus协议，不需要交纳许可证费，也不会侵犯知识产权，且支持Modbus的厂家和产品多。    
2. Modbus可以支持多种电气接口，如RS-232、RS-485等，还可以在各种介质上传送，如双绞线、光纤、无线等。  
3. Modbus的帧格式简单、紧凑，通俗易懂。用户使用容易，厂商开发简单。  

Modbus协议又分**Modbus RTU**（远程终端单元），**Modbus ASCII**（美国信息交换标准码）和后来发展的**Modbus TCP/IP**（传输控制协议/互联网协议）三种模式。其中前两种（Modbus RTU，Modbus ASCII）所用的物理硬件接口都是串行（Serial）通讯（RS232，RS485）。而Modbus TCP则是为了顺应当今世界发展潮流，什么都可以用Ethernet网或Internet来连接，传送数据。所以又产生Modbus TCP模式，该模式的硬件接口是以太网（Ethernet）口，也就是我们电脑上一般用的网口。

- 基于串口的Modbus-RTU  
>Modbus RTU 是 Modbus 协议的二进制实现版本。它通常用于串行通信，并以其紧凑的数据表示方式而闻名，这使得它具备高效和快速的特点。Modbus-RTU数据按照标准串口协议进行编码，是使用最广泛的一种Modbus协议，采用CRC-16_Modbus校验算法。  
>>   例：发送0x03 ：`0000 0011`  

- 基于串口的Modbus-ASCII  
>Modbus ASCII 是 Modbus 协议的 ASCII 实现版本。与 Modbus RTU 相比，它的效率较低，但由于使用人类可读的字符，因此更容易使用和调试。Modbus-ASCII所有数据都是ASCII格式，一个字节的原始数据需要两个字符来表示，效率低，采用LRC校验算法。  
>>   例：发送0x03（拆分为0和3，以ASCII表示，发送`'0'`和`'3'`） ：  
>>（发送0 ：0x30：`0011 0000` ）（ 发送3：0x33：`0011 0011`）

- 基于网口的Modbus-TCP  
>Modbus TCP/IP 是在 TCP/IP 网络上使用的 Modbus 协议版本。它支持长距离和跨不同网络的通信。Modbus-TCP基于TCP/IP协议，占用502端口，数据帧主要包括两部分：MBAP（报文头）+PDU（帧结构），数据块与串行链路是一致的。

### **Modbus协议规范**

MODBUS 协议定义了一个与基础通信层无关的简单协议数据单元（PDU）。特定总线或网络上的 MODBUS 协议映射能够在应用数据单元（ADU）上引入一些附加域。  

![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/9Ntu1AEqS5wEfnGS.png)

启动 MODBUS 事务处理的客户机创建 MODBUS 应用数据单元(ADU)。  
>注：发出数据请求的一方为客户端（Client），做出数据应答的的一方为服务器（Server）。  

串行链路上第一个 MODBUS 执行的长度约束限制了MODBUS PDU 大小（最大 RS485ADU=256字节）。因此，对串行链路通信来说，MODBUS PDU=256 - 服务器地址（1 字节）- CRC（2 字节）＝ 253字节。

MODBUS 使用一个‘big-Endian’ 表示地址和数据项。这意味着当发射多个字节时，首先发送最高有效位。  

#### **地址域**  
合法的地址范围为 十进制0 - 247，其中 0 为广播地址，从站的实际地址范围为 1 - 247。主节点通过将子节点的地址放到报文的地址域对子节点寻址。当子节点返回应答时， 它将自己的地址放到应答报文的地址域以让主节点知道哪个子节点在回答。

#### **功能码**  
功能码向服务器指示将执行哪种操作。用一个字节编码 MODBUS 数据单元的功能码域。有效的码字范围是十进制 1-255（128-255 为异常响应保留）。当从客户机向服务器设备发送报文时，功能码域通知服务器执行哪种操作。在某种请求中，数据域可以是不存在的（0 长度），在此情况下服务器不需要任何附加信息。功能码仅说明操作。当服务器对客户机响应时，它使用功能码域来指示正常（无差错）响应或者出现某种差错（称为异常响应）。对于一个正常响应来说，服务器仅对原始功能码响应。  
功能码有公共功能码和用户定义功能码（两个范围，十进制 65 至 72 和十进制 100 至 110）  
![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/EOdZsC1WEtaHAp6z.png)  
![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/stMwdYkvacspHvbr.png)  

#### **数据**  
有两种串行传输模式被定义: RTU 模式 和 ASCII 模式。Modbus 串行链路上所有设备的传输模式 (和串行口参数) 必须相同。所有设备必须必须实现 RTU 模式。ASCII 传输模式是选项。

- RTU 传输模式  
>当设备使用 RTU (Remote Terminal Unit) 模式在 Modbus串行链路通信， 报文中每个 8 位字节含有两个 4 位十六进制字符。这种模式的主要优点是较高的数据密度，在相同的波特率下比 ASCII 模式有更高的吞吐率。每个报文必须以连续的字符流传送。  
>RTU 模式每个字节 ( 11 位 ) 的格式为 :1 起始位、8 数据位(首先发送LSB)、0/1 奇偶校验位、1/2停止位(使用无校验要求 2 个停止位)。  
>![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/Tutvkc6jJLp0NZGG.png)  

- ASCII 模式  
>当 Modbus串行链路的设备被配置为使用 ASCII (American Standard Code for Information Interchange) 模式通信时， 报文中的每个 8 位子节以两个 ASCII 字符发送。当通信链路或者设备无法符合 RTU 模式的定时管理时使用该模式。注 : 由于一个子节需要两个字符，此模式比 RTU 效率低。例 : 子节 0X5B 会被编码为两个字符 : 0x35 和 0x42 ( ASCII 编码 0x35 ="5"， 0x42 ="B" )。  
>ASCII 模式每个字节 ( 10 位 ) 的格式为 :1 起始位、7 数据位(首先发送LSB)、0/1 奇偶校验位、1/2停止位(使用无校验要求 2 个停止位)。  
>![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/sH7zxP2Fw1btfi3O.png)

#### **差错校验**  
错误检验域是对报文内容执行 "冗余校验" 的计算结果。根据不同的传输模式 (RTU or ASCII)使用两种不同的计算方法。  

- RTU 模式---循环冗余校验 (CRC)  
>在 RTU 模式包含一个对全部报文内容执行的，基于循环冗余校验 (CRC - Cyclical Redundancy Checking) 算法的错误检验域。CRC 域检验整个报文的内容。不管报文有无奇偶校验，均执行此检验。  
>CRC 包含由两个 8 位字节组成的一个 16 位值。  
>CRC 域作为报文的最后的域附加在报文之后。当 16 位 CRC (2 个 8 位字节) 在报文中传送时，低位字节首先发送，然后是高位字节。例如，如果 CRC 值为十六进制 1241 (0001 0010 0100 0001)，则依次发送0x41、0x12。  
>附加在报文后面的 CRC 的值由发送设备计算。接收设备在接收报文时重新计算 CRC 的值，并将计算结果于实际接收到的 CRC 值相比较。如果两个值不相等，则为错误。  
>![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/K6nHrg9JdLQYbPjY.png)  
>>生成 CRC 的过程为:  
> 1. 将一个 16 位寄存器装入十六进制 FFFF (全 1). 将之称作 CRC 寄存器.  
> 2. 将报文的第一个 8 位字节与 16 位 CRC 寄存器的低字节异或，结果置于 CRC 寄存器.（只有字符中的 8 个数据位参与生成 CRC 的运算，起始位，停止位和校验位不参与 CRC计算）  
> 3. 将 CRC 寄存器右移 1 位 (向 LSB 方向)， MSB 充零. 提取并检测 LSB.  
> 4. (如果 LSB 为 0): 重复步骤 3 (另一次移位)；(如果 LSB 为 1): 对 CRC 寄存器异或固定的预置多项式值 0xA001 (1010 0000 0000 0001).  
> 5. 重复步骤 3 和 4，直到完成 8 次移位。当做完此操作后，将完成对 8 位字节的完整操作。  
> 6. 对报文中的下一个字节重复步骤 2 到 5，继续此操作直至所有报文被处理完毕。  
> 7. CRC 寄存器中的最终内容为 CRC 值.  
> 8. 当放置 CRC 值于报文时，高低字节必须交换。  

- ASCII 模式---LRC纵向冗余校验  
> 在 ASCII 模式，包含一个对全部报文内容执行的，基于纵向冗余校验 (LRC - Longitudinal Redundancy Checking) 算法的错误检验域。LRC 域检验不包括起始“冒号”和结尾 CRLF 对的整个报文的内容。不管报文有无奇偶校验，均执行此检验。LRC 域为一个子节，包含一个 8 位二进制值。LRC 值由发送设备计算，然后将 LRC 附在报文后面。接收设备在接收报文时重新计算 LRC 的值，并将计算结果于实际接收到的 LRC 值相比较。如果两个值不相等，则为错误。  
> 当 8 位 LRC (2 个 ASCII 字符) 在报文中传送时，高位字符首先发送，然后是低位字符。例如，如果 LRC 值为十六进制 61 (0110 0001)，则依次发送0x36("6")、0x31("1")。（注意与CRC区分）  
>![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/ao06X0wOskmrk3cU.png)  
>>LRC 的计算, 对报文中的所有的连续 8 位字节相加，忽略任何进位，然后求出其二进制补码。  
>生成一个 LRC的过程为:  
>1. 不包括起始”冒号”和结束 CRLF 的报文中的所有字节相加到一个 8 位域，故此进位被丢弃。  
>2. 从 FF (全 1)十六进制中减去域的最终值，产生 1 的补码(二进制反码)。  
>3. 加 1 产生二进制补码.

### 报文帧

- RTU 传输模式  
>![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/tDTIZlFH7vnIbg59.png)  
>在 RTU 模式，报文帧由时长至少为 3.5 个字符时间的空闲间隔区分。在后续的部分，这个时间区间被称作 t3.5。  
>![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/JWgAvJwF09Z8tMoH.png)  
>整个报文帧必须以连续的字符流发送。如果两个字符之间的空闲间隔大于 1.5 个字符时间，则报文帧被认为不完整应该被接收节点丢弃。  
>![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/vXYMV7cnWYkSxim4.png)
>![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/BzqIvaOUnG0e914H.png)  

- ASCII 模式   
>报文帧的地址域含有两个字符。  
>在 ASCII 模式， 报文用特殊的字符区分帧起始和帧结束。一个报文必须以一个‘冒号’ ( : )(ASCII 十六进制 3A )起始，以 ‘回车-换行’ (CR LF) 对 (ASCII 十六进制 0D 和 0A) 结束。  
>注 : LF 字符可以通过特定的 Modbus 应用命令 (参见 Modbus 应用协议规范) 改变。  
>对于所有的域，允许传送的字符为十六进制 0–9， A–F (ASCII 编码)。 设备连续的监视总线上的 ‘冒号’ 字符。 当收到这个字符后，每个设备解码后续的字符一直到帧结束。  
>报文中字符间的时间间隔可以达一秒。如果有更大的间隔，则接受设备认为发生了错误。   
>![输入图片说明](/imgs/protocol-rs485-modbus/2023-09-12/oQKtNg8MWYjTvMVx.png)

## Reference
- [# 一文看懂RS-485总线](https://www.eet-china.com/mp/a63373.html)  
- [# RS-485总线，这篇很详细](https://www.eet-china.com/mp/a55570.html)  
- [# RS-485总线，这篇很详细（wx）](https://mp.weixin.qq.com/s/plW_kt4k6uB6iXD8jlVRRg)  
- [# Modbus通讯协议从一窍不通到原来如此](https://blog.csdn.net/qq_41965346/article/details/118760449)
- [# 网盘：Modbus协议规范（中文）](https://pan.baidu.com/link/zhihu/7Fh0zcuVhlijMX1Exka3EshzTpW0V2Rwd4NF==)